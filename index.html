<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Cobranzas - ISO 9001</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin para etiquetas de datos en Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Librerías para Exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- Navbar (Oculta en PDF) -->
    <nav class="bg-[#9bc438] text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <!-- Logo de Corvus sin fondo blanco (ID agregado para capturarlo fácil) -->
                <!-- IMPORTANTE: Esta imagen debe estar en el mismo directorio que el archivo HTML -->
                <img id="navbarLogo" src="new_corvus_logo.png" alt="Corvus Logo" class="h-10 mr-2">
                <h1 class="text-xl font-bold tracking-wide text-white drop-shadow-md">Gestión de Cobranzas</h1>
            </div>
            <div class="text-sm opacity-90 flex items-center gap-2 font-semibold">
                <span id="currentDateDisplay"></span>
                <span>| Panel v3.48</span>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-6 space-y-6" id="dashboardContainer">

        <!-- Controls Area (SE OCULTARÁ COMPLETAMENTE EN EL PDF) -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200" id="controlsSection">
            <div class="flex flex-col md:flex-row gap-4 items-end justify-between">

                <!-- Data Source Config -->
                <div class="w-full md:w-1/2" id="dataSourceConfig">
                    <label class="block text-xs font-medium text-slate-400 mb-1">Origen de Datos</label>
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2 items-center">
                            <button id="importBtn"
                                class="bg-[#9bc438] hover:bg-green-600 text-white text-xs font-bold py-1 px-4 rounded whitespace-nowrap flex items-center gap-2 transition shadow-sm">
                                <i class="fa-solid fa-cloud-arrow-down"></i>
                                <span id="btnText">Importar Datos</span>
                            </button>
                            <button id="toggleLinkBtn"
                                class="text-slate-400 hover:text-slate-600 text-xs flex items-center gap-1 focus:outline-none"
                                title="Configurar Link">
                                <i class="fa-solid fa-link"></i> <span class="underline">Configurar Link</span>
                            </button>
                        </div>
                        <div id="urlInputContainer" class="hidden">
                            <input type="text" id="sheetUrlInput"
                                value="https://docs.google.com/spreadsheets/d/1wVjmZDIWLZvwunf7NrkqSh91yE2e31a286Y0zFDsZRE/edit?usp=sharing"
                                class="w-full bg-slate-50 border-gray-200 rounded text-xs text-slate-500 px-2 py-1 focus:ring-0 border-0"
                                readonly />
                        </div>
                    </div>
                </div>

                <!-- Filter & PDF Button Container -->
                <div class="w-full md:w-1/2 flex gap-4 items-end justify-end">
                    <!-- Filter -->
                    <div class="w-1/2" id="monthFilterContainer">
                        <label class="block text-sm font-bold text-slate-700 mb-1">Filtrar por Mes de
                            Vencimiento</label>
                        <select id="monthFilter"
                            class="w-full border-blue-300 rounded-md shadow-sm p-2 border-2 focus:ring-blue-500 focus:border-blue-500 bg-blue-50 text-blue-900 font-semibold disabled:opacity-50"
                            disabled>
                            <option value="TODOS">Esperando datos...</option>
                        </select>
                    </div>

                    <!-- PDF Button -->
                    <div class="w-1/4" id="pdfButtonContainer">
                        <button id="downloadPdfBtn"
                            class="w-full bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded transition shadow-md disabled:opacity-50 flex items-center justify-center gap-2"
                            disabled>
                            <i class="fa-solid fa-file-pdf"></i>
                            <span id="pdfBtnText">PDF</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards (6 columns now) -->
        <div id="kpiSection" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">

            <!-- 1. Conectividades (Casos Activos) -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500 card">
                <div class="text-slate-500 text-sm font-semibold uppercase">Conectividades</div>
                <div class="text-3xl font-bold mt-1" id="kpiTotal">0</div>
                <div class="text-xs text-slate-400 mt-1">Casos activos</div>
            </div>

            <!-- 2. Cobradas (Cantidad) -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500 card">
                <div class="text-slate-500 text-sm font-semibold uppercase">COBRADAS</div>
                <div class="text-3xl font-bold mt-1 text-green-700" id="kpiCollected">0</div>
                <div class="text-xs text-slate-400 mt-1">Casos cerrados</div>
            </div>

            <!-- 3. Cobradas % -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500 card">
                <div class="text-slate-500 text-sm font-semibold uppercase">Cobradas</div>
                <div class="text-3xl font-bold mt-1" id="kpiEfficiencyNet">0%</div>
                <div class="text-xs text-slate-400 mt-1">Casos cerrados</div>
            </div>

            <!-- 4. Casos Excluidos (Susp./No se cobra) -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500 card">
                <div class="text-slate-500 text-sm font-semibold uppercase">EXCLUIDOS</div>
                <div class="text-3xl font-bold mt-1" id="kpiBajas">0</div>
                <div class="text-xs text-slate-400 mt-1">Suspendidas/No se cobra</div>
            </div>

            <!-- 5. Bonificadas (NUEVO KPI) -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500 card">
                <div class="text-slate-500 text-sm font-semibold uppercase">Bonificadas</div>
                <div class="text-3xl font-bold mt-1" id="kpiBonificadas">0</div>
                <div class="text-xs text-slate-400 mt-1">Inc. concesionarios</div>
            </div>

            <!-- 6. Alerta (+3 días) -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500 card">
                <div class="text-slate-500 text-sm font-semibold uppercase">ALERTAS (+3 DÍAS)</div>
                <div class="text-3xl font-bold mt-1 text-red-600" id="kpiStagnant">0</div>
                <div class="text-xs text-slate-400 mt-1">Requieren gestión</div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden grid grid-cols-1 gap-6">

            <!-- Status Chart -->
            <div class="bg-white p-6 rounded-lg shadow flex flex-col items-center">
                <h3 class="font-bold text-slate-700 mb-4 w-full text-left">Distribución de Cobranzas</h3>
                <!-- Contenedor ajustado para barra horizontal -->
                <div class="h-20 w-full max-w-4xl flex items-center justify-center">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- Collectors Table -->
            <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                <h3 class="font-bold text-slate-700 mb-4">Desempeño por Responsable</h3>
                <table class="min-w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="px-6 py-3 text-left">Responsable</th>
                            <th class="px-6 py-3 text-center">Total</th>
                            <th class="px-6 py-3 text-blue-600 text-center">Facturadas</th>
                            <th class="px-6 py-3 text-yellow-600 text-center">Facturac pendiente</th>
                            <th class="px-6 py-3 text-green-700 text-center">Cobradas</th>
                            <th class="px-6 py-3 text-blue-700 font-bold text-center">Efectividad Cobro</th>
                            <th class="px-6 py-3 text-red-600 text-center">Alerta (+3 días)</th>
                            <th class="px-6 py-3 text-center">Última Gestión</th>
                        </tr>
                    </thead>
                    <tbody id="collectorsTableBody"></tbody>
                </table>
            </div>

            <!-- Stagnant Lists -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-lg border-b pb-2">
                    <i class="fa-solid fa-bell text-red-500"></i> Casos sin movimiento (> 3 días)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-red-50 rounded-lg p-3 border border-red-100">
                        <h4 class="font-bold text-red-800 mb-3 flex justify-between"><span><i
                                    class="fa-solid fa-triangle-exclamation mr-2"></i>DISPUTAS/ERRORES</span><span
                                class="bg-red-200 text-red-800 text-xs px-2 py-1 rounded-full"
                                id="count-reclamos">0</span></h4>
                        <div class="overflow-y-auto max-h-80 space-y-2" id="list-reclamos"></div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                        <h4 class="font-bold text-blue-800 mb-3 flex justify-between"><span><i
                                    class="fa-solid fa-file-invoice-dollar mr-2"></i>PENDIENTES PAGO</span><span
                                class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full"
                                id="count-facturas">0</span></h4>
                        <div class="overflow-y-auto max-h-80 space-y-2" id="list-facturas"></div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-100">
                        <h4 class="font-bold text-yellow-800 mb-3 flex justify-between"><span><i
                                    class="fa-solid fa-phone mr-2"></i>CONTACTADO</span><span
                                class="bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded-full"
                                id="count-contactos">0</span></h4>
                        <div class="overflow-y-auto max-h-80 space-y-2" id="list-contactos"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Register ChartDataLabels plugin explicitly
        Chart.register(ChartDataLabels);

        // Alias para jspdf
        const { jsPDF } = window.jspdf;

        let rawData = [];
        let statusChartInstance = null;
        let globalTotalSinBajas = 0;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('currentDateDisplay').textContent = 'Fecha: ' + today.toLocaleDateString('es-AR');
        });

        document.getElementById('importBtn').addEventListener('click', loadDataFromSheet);
        document.getElementById('monthFilter').addEventListener('change', runDashboard);
        document.getElementById('downloadPdfBtn').addEventListener('click', generatePDF);
        document.getElementById('toggleLinkBtn').addEventListener('click', () => {
            const container = document.getElementById('urlInputContainer');
            container.classList.toggle('hidden');
        });

        // --- UTILITY: Load Image As Base64 (Fixes PNG Corrupt Error) ---
        function loadLogoAsBase64(imgElement) {
            return new Promise((resolve, reject) => {
                if (!imgElement || !imgElement.src) return resolve(null); // Resolve to null if no source

                // Use a new Image object to ensure we can listen for load events
                const img = new Image();
                img.crossOrigin = 'Anonymous'; // Attempt to load cross-origin without tainting the canvas
                img.src = imgElement.src;

                // Check if already loaded (might happen if the image is cached)
                if (img.complete && img.naturalHeight !== 0) {
                    try {
                        const canvas = document.createElement("canvas");
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0);
                        return resolve(canvas.toDataURL("image/png"));
                    } catch (e) {
                        return reject(new Error("Canvas Taint Error on sync load: " + e.message));
                    }
                }

                img.onload = () => {
                    try {
                        const canvas = document.createElement("canvas");
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL("image/png"));
                    } catch (e) {
                        reject(new Error("Canvas Taint Error on async load: " + e.message));
                    }
                };

                img.onerror = () => {
                    // Fail gracefully and continue without the logo
                    resolve(null);
                };
            });
        }

        // --- PDF GENERATION ---
        async function generatePDF() {
            const pdfBtn = document.getElementById('downloadPdfBtn');
            const pdfBtnText = document.getElementById('pdfBtnText');
            const container = document.getElementById('dashboardContainer');
            const controlsSection = document.getElementById('controlsSection');

            // 1. UI state
            pdfBtn.disabled = true;
            pdfBtnText.textContent = "Generando...";

            // 2. Ocultar elementos que NO deben ir en el PDF
            const navbar = document.querySelector('nav');

            // Ocultar TODA la sección de controles y navbar
            controlsSection.style.display = 'none';
            navbar.style.display = 'none';

            // 3. Get current state info para el header fijo + Capturar logo base64 (AWAIT)
            const reportDate = document.getElementById('currentDateDisplay').textContent;
            const selectedMonth = document.getElementById('monthFilter').options[document.getElementById('monthFilter').selectedIndex].text;

            const logoImgElement = document.getElementById('navbarLogo');
            let logoBase64 = null;
            try {
                // Await the asynchronous load of the logo
                logoBase64 = await loadLogoAsBase64(logoImgElement);
            } catch (e) {
                console.warn("No se pudo cargar el logo para PDF. Se continuará sin logo.", e);
                logoBase64 = null;
            }

            // 4. Capturar el contenido principal
            const canvas = await html2canvas(container, {
                scale: 2,
                allowTaint: true,
                useCORS: true,
            });

            // 5. Restaurar elementos ocultos
            navbar.style.display = 'block';
            controlsSection.style.display = 'block';

            // 6. Crear PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            const headerOffset = 30;

            // 7. Add Header/Title and Logo
            if (logoBase64) {
                const pdfLogoHeight = 12; // Altura fija en mm
                // El tamaño natural de la imagen ahora está en el canvas temporal, no en el elemento del DOM, por lo que usamos un valor de fallback/estimado si es necesario. 
                const logoRatio = logoImgElement.naturalWidth && logoImgElement.naturalHeight ? logoImgElement.naturalWidth / logoImgElement.naturalHeight : 1;
                const pdfLogoWidth = pdfLogoHeight * logoRatio;

                pdf.addImage(logoBase64, 'PNG', margin, 10, pdfLogoWidth, pdfLogoHeight);

                // Ajustar texto a la derecha del logo
                const textX = margin + pdfLogoWidth + 5;

                pdf.setFontSize(18);
                pdf.setFont('inter', 'bold');
                pdf.setTextColor(25, 25, 112);
                pdf.text("REPORTE DE COBRANZAS (ISO 9001)", textX, 16);

                pdf.setFontSize(12);
                pdf.setFont('inter', 'normal');
                pdf.setTextColor(50, 50, 50);
                pdf.text(`${reportDate} | Mes Seleccionado: ${selectedMonth}`, textX, 23);
            } else {
                // Fallback sin logo
                pdf.setFontSize(18);
                pdf.setFont('inter', 'bold');
                pdf.setTextColor(25, 25, 112);
                pdf.text("REPORTE DE COBRANZAS (ISO 9001)", margin, 15);

                pdf.setFontSize(12);
                pdf.setFont('inter', 'normal');
                pdf.setTextColor(50, 50, 50);
                pdf.text(`${reportDate} | Mes Seleccionado: ${selectedMonth}`, margin, 22);
            }

            // 8. Add Captured Image (Content)
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const imgProps = pdf.getImageProperties(imgData);

            const contentWidth = pdfWidth - 2 * margin;
            const contentHeight = (imgProps.height * contentWidth) / imgProps.width;

            let currentY = headerOffset;

            // Lógica de ajuste a una página
            if (contentHeight <= pdfHeight - headerOffset - margin) {
                pdf.addImage(imgData, 'JPEG', margin, currentY, contentWidth, contentHeight);
            } else {
                const overflowRatio = contentHeight / (pdfHeight - headerOffset - margin);
                if (overflowRatio < 1.2) {
                    pdf.addImage(imgData, 'JPEG', margin, currentY, contentWidth, pdfHeight - headerOffset - margin);
                } else {
                    let position = 0;
                    while (position < contentHeight) {
                        if (position > 0) {
                            pdf.addPage();
                            currentY = margin;
                        }

                        const remainingHeight = contentHeight - position;
                        const heightToDraw = Math.min(remainingHeight, pdfHeight - currentY - margin);

                        const sliceY_canvas = position * (canvas.height / contentHeight);
                        const sliceHeight_canvas = heightToDraw * (canvas.height / contentHeight);

                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = canvas.width;
                        tempCanvas.height = sliceHeight_canvas;
                        const ctx = tempCanvas.getContext('2d');

                        ctx.drawImage(canvas, 0, sliceY_canvas, canvas.width, sliceHeight_canvas, 0, 0, tempCanvas.width, tempCanvas.height);

                        pdf.addImage(tempCanvas.toDataURL('image/jpeg', 0.9), 'JPEG', margin, currentY, contentWidth, heightToDraw);

                        position += heightToDraw;
                    }
                }
            }

            const month = document.getElementById('monthFilter').value;
            const today = new Date().toISOString().slice(0, 10);
            pdf.save(`Reporte_Cobranzas_${month}_${today}.pdf`);

            pdfBtn.disabled = false;
            pdfBtnText.textContent = "PDF";
        }


        // --- DATA LOADING ---
        async function loadDataFromSheet() {
            const urlInput = document.getElementById('sheetUrlInput').value;
            const btn = document.getElementById('importBtn');
            const btnText = document.getElementById('btnText');
            const filterSelect = document.getElementById('monthFilter');
            const pdfBtn = document.getElementById('downloadPdfBtn');

            btn.disabled = true;
            pdfBtn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-wait');
            btnText.textContent = "Cargando...";

            document.getElementById('kpiSection').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');

            if (!urlInput) {
                alert("No hay enlace de hoja configurado.");
                resetBtn();
                return;
            }

            const match = urlInput.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!match || !match[1]) {
                alert("Enlace inválido. Verifica la URL.");
                resetBtn();
                return;
            }

            const sheetId = match[1];
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;

            try {
                await fetchAndParse(csvUrl);
                finishLoading();
            } catch (error1) {
                console.warn("Intento directo fallido, probando proxy...", error1);
                try {
                    await fetchAndParse(proxyUrl);
                    finishLoading();
                } catch (error2) {
                    console.error("Fallo definitivo en la carga:", error2);
                    alert("No se pudo conectar. Verifica que la hoja sea pública o tenga el enlace compartido correctamente.");
                    resetBtn();
                }
            }

            function resetBtn() {
                btn.disabled = false;
                pdfBtn.disabled = true;
                btn.classList.remove('opacity-75', 'cursor-wait');
                btn.classList.remove('bg-[#9bc438]', 'hover:bg-green-600');
                btn.classList.add('bg-[#9bc438]', 'hover:bg-green-600');
                btnText.textContent = "Importar Datos";
                filterSelect.disabled = true;
                filterSelect.innerHTML = '<option value="TODOS">Esperando datos...</option>';
            }

            function finishLoading() {
                btn.disabled = false;
                pdfBtn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-wait');
                btn.classList.remove('bg-[#9bc438]', 'hover:bg-green-600');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btnText.textContent = "Datos Actualizados";
                filterSelect.disabled = false;

                // --- CAMBIO CLAVE AQUÍ: Seleccionar el mes actual ---
                const monthFilter = document.getElementById('monthFilter');
                const currentMonthName = new Date().toLocaleDateString('es-AR', { month: 'long' }).toUpperCase();

                let monthToSelect = 'TODOS';
                // Buscar el mes actual en las opciones (o el más cercano si hay variaciones)
                for (const option of monthFilter.options) {
                    if (option.value === currentMonthName) {
                        monthToSelect = currentMonthName;
                        break;
                    }
                }

                // Si encontramos el mes actual, lo seleccionamos.
                if (monthToSelect !== 'TODOS') {
                    monthFilter.value = monthToSelect;
                } else {
                    // Si no está el mes actual, seleccionamos el último mes en la lista para tener algo cargado
                    if (monthFilter.options.length > 1) {
                        monthFilter.value = monthFilter.options[monthFilter.options.length - 1].value;
                    }
                }

                // Y luego ejecutamos el dashboard con la nueva selección
                runDashboard();

                // Restaurar visibilidad
                document.getElementById('kpiSection').classList.remove('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');

                setTimeout(() => {
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-[#9bc438]', 'hover:bg-green-600');
                    btnText.textContent = "Recargar Datos";
                }, 3000);
            }
        }

        function fetchAndParse(url) {
            return new Promise(async (resolve, reject) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const csvText = await response.text();
                    if (!csvText || csvText.length < 50) throw new Error("Respuesta vacía");

                    Papa.parse(csvText, {
                        header: false,
                        skipEmptyLines: true,
                        quoteChar: '"',
                        escapeChar: '"',
                        complete: function (results) {
                            handleParseResults(results);
                            resolve();
                        },
                        error: function (err) { reject(err); }
                    });
                } catch (err) {
                    clearTimeout(timeoutId);
                    reject(err);
                }
            });
        }

        function handleParseResults(results) {
            const totalRowsRead = results.data.length;
            if (totalRowsRead > 1) {
                rawData = results.data.slice(1);
                populateMonthFilter();
                // runDashboard() is now called inside finishLoading()
            } else {
                throw new Error("Datos insuficientes.");
            }
        }

        // --- CORE CALCULATIONS ---
        function categorizeStatus(statusRaw) {
            const s = (statusRaw || '').toUpperCase();

            // 1. EXCLUIDO (Bajas/Fugas)
            if (s.includes('NO SE COBRA') || s.includes('SUSPENDIDO') || s.includes('BONIFICADA') || s.includes('EXCLUIDO')) return 'EXCLUIDO';

            // 2. COBRADAS (Éxito)
            const isExplicitSuccess = s.includes('YA PAGO') || s.includes('PAGADO') || s.includes('COBRADA') || s.includes('COBRADO') || s.includes('ABONADO') || s.includes('CERRAD');
            if (isExplicitSuccess) return 'COBRADAS';

            // 3. ASIGNADAS (NUEVO: Vacío o explícito)
            if (s === '' || s.includes('ASIGNADA')) return 'ASIGNADA';

            // 4. DISPUTAS/ERRORES (Trabas)
            if (s.includes('RECLAMO') || s.includes('DISPUTA') || s.includes('ERROR') || s.includes('PROBLEMA') || s.includes('DEVUELT')) return 'DISPUTAS_O_TRABAS';

            // 5. PENDIENTES DE PAGO (Facturación)
            if (s.includes('FACTURA') || s.includes('FC') || s.includes('ENVIAD') || s.includes('ADMIN') || s.includes('NOTA DE') || s.includes('PENDIENTE') || s.includes('ESPERA') || s.includes('PAGO') || s.includes('A PAGAR')) return 'PENDIENTES_PAGO';

            // 6. CONTACTADO (Seguimiento)
            return 'CONTACTADO';
        }

        function getMonthValue(monthName) {
            const normalizedName = monthName.toUpperCase().replace(/\s/g, '');
            switch (normalizedName) {
                case 'ENERO': case 'ENE': case '1': return 1;
                case 'FEBRERO': case 'FEB': case '2': return 2;
                case 'MARZO': case 'MAR': case '3': return 3;
                case 'ABRIL': case 'ABR': case '4': return 4;
                case 'MAYO': case 'MAY': case '5': return 5;
                case 'JUNIO': case 'JUN': case '6': return 6;
                case 'JULIO': case 'JUL': case '7': return 7;
                case 'AGOSTO': case 'AGO': case '8': return 8;
                case 'SEPTIEMBRE': case 'SEP': case '9': return 9;
                case 'OCTUBRE': case 'OCT': case '10': return 10;
                case 'NOVIEMBRE': case 'NOV': case '11': return 11;
                case 'DICIEMBRE': case 'DIC': case '12': return 12;
                default: return 99;
            }
        }

        function populateMonthFilter() {
            const months = new Set();
            rawData.forEach(row => {
                if (row.length > 8) {
                    const month = row[8];
                    if (month) months.add(month.trim().toUpperCase());
                }
            });

            const monthArray = Array.from(months).map(m => {
                const isMultiMonth = m.includes('-') || m.includes('Y') || m.includes('/');
                let sortValue = getMonthValue(m);

                if (sortValue === 99 && isMultiMonth) {
                    sortValue = 99;
                }

                return { name: m, sortValue: sortValue };
            });

            monthArray.sort((a, b) => {
                if (a.sortValue < b.sortValue) return -1;
                if (a.sortValue > b.sortValue) return 1;
                return a.name.localeCompare(b.name);
            });

            const select = document.getElementById('monthFilter');
            const currentSelection = select.value;
            select.innerHTML = '<option value="TODOS">Todos</option>';

            monthArray.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                opt.textContent = m.name;
                select.appendChild(opt);
            });

            if (currentSelection && Array.from(select.options).some(o => o.value === currentSelection)) {
                select.value = currentSelection;
            }
        }

        function parseDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const parts = dateStr.split(' ');
            const dateParts = parts[0].split('/');
            if (dateParts.length < 3) return null;
            const year = parseInt(dateParts[2], 10);
            const monthIndex = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[0], 10);
            const dateOnly = new Date(year, monthIndex, day, 0, 0, 0);
            if (isNaN(dateOnly.getTime())) return null;
            return dateOnly;
        }

        function getDaysDiff(dateObj) {
            if (!dateObj) return 999;
            const MS_PER_DAY = 1000 * 60 * 60 * 24;
            const now = new Date();
            const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const diffTime = todayMidnight.getTime() - dateObj.getTime();
            return Math.floor(diffTime / MS_PER_DAY);
        }

        function runDashboard() {
            const QUIEN_COBRA_INDEX = 13;
            const ESTADO_INDEX = 14;
            const FECHA_CAMBIO_INDEX = 15;

            const selectedMonth = document.getElementById('monthFilter').value;

            let total = 0;
            let cobradas = 0;
            let stagnantTotal = 0;
            let bajasTotal = 0;
            let bonificadasTotal = 0;

            const categoryCounts = { 'ASIGNADA': 0, 'DISPUTAS_O_TRABAS': 0, 'PENDIENTES_PAGO': 0, 'CONTACTADO': 0, 'COBRADAS': 0, 'EXCLUIDO': 0 };
            const stagnantGroups = { 'DISPUTAS_O_TRABAS': [], 'PENDIENTES_PAGO': [], 'CONTACTADO': [], 'ASIGNADA': [] };
            const collectorStats = {};

            rawData.forEach(row => {
                if (row.length < 16) return;

                const rowMonth = (row[8] || '').trim().toUpperCase();
                if (selectedMonth !== 'TODOS' && rowMonth !== selectedMonth) return;

                total++;
                const collector = (row[QUIEN_COBRA_INDEX] || 'SIN ASIGNAR').trim().toUpperCase();
                const statusRaw = (row[ESTADO_INDEX] || 'SIN ESTADO').trim();
                const dateStr = row[FECHA_CAMBIO_INDEX];
                const dateObj = parseDate(dateStr);
                const daysDiff = getDaysDiff(dateObj);

                const category = categorizeStatus(statusRaw);
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;

                if (statusRaw.toUpperCase().includes('BONIFICADA')) {
                    bonificadasTotal++;
                }

                if (category === 'EXCLUIDO') {
                    bajasTotal++;
                }

                if (!collectorStats[collector]) collectorStats[collector] = { name: collector, total: 0, cobrada: 0, pending: 0, facturadas: 0, stagnant: 0, lastDate: null };

                const fullDateParts = dateStr && dateStr.includes(' ') ? (dateStr.split(' ')[1] || '00:00:00').split(':') : ['00', '00', '00'];
                const fullDateObj = dateObj ? new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), fullDateParts[0], fullDateParts[1], fullDateParts[2]) : null;

                if (fullDateObj) {
                    if (!collectorStats[collector].lastDate || fullDateObj > collectorStats[collector].lastDate) {
                        collectorStats[collector].lastDate = fullDateObj;
                    }
                }

                collectorStats[collector].total++;

                if (category === 'COBRADAS') {
                    cobradas++;
                    collectorStats[collector].cobrada++;
                } else if (category !== 'EXCLUIDO') {
                    collectorStats[collector].pending++;
                    if (category === 'PENDIENTES_PAGO') {
                        collectorStats[collector].facturadas++;
                    }
                }

                if (category !== 'EXCLUIDO' && category !== 'COBRADAS') {
                    if (daysDiff > 3 || daysDiff === 999) {
                        stagnantTotal++;
                        collectorStats[collector].stagnant++;
                        if (stagnantGroups[category]) {
                            stagnantGroups[category].push({
                                client: row[2] || row[4] || 'Cliente Desconocido',
                                collector: collector,
                                rawStatus: statusRaw,
                                dateStr: dateStr || 'Sin Fecha',
                                days: daysDiff
                            });
                        }
                    }
                }
            });

            globalTotalSinBajas = total - bajasTotal;
            const finalAdjustedTotal = globalTotalSinBajas;

            document.getElementById('kpiTotal').textContent = finalAdjustedTotal;
            document.getElementById('kpiStagnant').textContent = stagnantTotal;
            document.getElementById('kpiBajas').textContent = bajasTotal;
            document.getElementById('kpiBonificadas').textContent = bonificadasTotal;


            const conversionRate = finalAdjustedTotal > 0 ? Math.round((cobradas / finalAdjustedTotal) * 100) : 0;
            document.getElementById('kpiCollected').textContent = cobradas;
            document.getElementById('kpiEfficiencyNet').textContent = conversionRate + '%';

            const grandTotalAssigned = total;
            const grandTotalCobradas = cobradas;
            const grandTotalPendientes = finalAdjustedTotal - cobradas;
            const grandTotalAlerta = stagnantTotal;
            const grandTotalFacturadas = categoryCounts['PENDIENTES_PAGO'] || 0;


            updateStatusChart(categoryCounts, finalAdjustedTotal);
            renderCollectorsTable(collectorStats, grandTotalAssigned, grandTotalCobradas, grandTotalPendientes, grandTotalAlerta, grandTotalFacturadas);
            renderStagnantGroup('list-reclamos', 'count-reclamos', stagnantGroups['DISPUTAS_O_TRABAS'], 'bg-white border-l-4 border-red-500');
            renderStagnantGroup('list-facturas', 'count-facturas', stagnantGroups['PENDIENTES_PAGO'], 'bg-white border-l-4 border-blue-500');
            const stagnantContactado = stagnantGroups['CONTACTADO'].concat(stagnantGroups['ASIGNADA']);
            renderStagnantGroup('list-contactos', 'count-contactos', stagnantContactado, 'bg-white border-l-4 border-yellow-500');
        }

        function renderCollectorsTable(stats, grandTotalAssigned, grandTotalCobradas, grandTotalPendientes, grandTotalAlerta, grandTotalFacturadas) {
            const tbody = document.getElementById('collectorsTableBody');
            tbody.innerHTML = '';

            const sortedStats = Object.values(stats)
                .filter(stat => stat.total > 0 || stat.name !== 'SIN ASIGNAR')
                // --- CAMBIO AQUÍ: Ordenar por nombre (Alfabético) ---
                .sort((a, b) => a.name.localeCompare(b.name));

            sortedStats.forEach(stat => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50";
                const lastInteraction = stat.lastDate ? stat.lastDate.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-';

                const activeTotal = stat.pending + stat.cobrada;
                let effectiveness = 0;
                if (activeTotal > 0) {
                    effectiveness = Math.round((stat.cobrada / activeTotal) * 100);
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900 text-left">${stat.name}</td>
                    <td class="px-6 py-4 text-center">${stat.total}</td>
                    <td class="px-6 py-4 text-blue-600 font-bold text-center">${stat.facturadas}</td>
                    <td class="px-6 py-4 text-yellow-600 font-bold text-center">${stat.pending - stat.facturadas}</td>
                    <td class="px-6 py-4 text-green-600 font-bold text-center">${stat.cobrada}</td>
                    <td class="px-6 py-4 text-blue-700 font-bold text-center">${effectiveness}%</td>
                    <td class="px-6 py-4 text-red-600 font-bold text-center">${stat.stagnant}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs text-center">${lastInteraction}</td>
                `;
                tbody.appendChild(tr);
            });

            const trTotal = document.createElement('tr');
            trTotal.className = "bg-slate-200 border-t-2 border-slate-500 font-extrabold text-slate-900";
            const totalActiveRow = grandTotalCobradas + grandTotalPendientes;
            const totalEffectivenessRow = totalActiveRow > 0 ? Math.round((grandTotalCobradas / totalActiveRow) * 100) : 0;

            trTotal.innerHTML = `
                <td class="px-6 py-4 text-left">TOTAL</td>
                <td class="px-6 py-4 text-center">${grandTotalAssigned}</td>
                <td class="px-6 py-4 text-blue-600 text-center">${grandTotalFacturadas}</td>
                <td class="px-6 py-4 text-yellow-600 text-center">${grandTotalPendientes - grandTotalFacturadas}</td>
                <td class="px-6 py-4 text-green-700 text-center">${grandTotalCobradas}</td>
                <td class="px-6 py-4 text-blue-700 text-center">${totalEffectivenessRow}%</td>
                <td class="px-6 py-4 text-red-600 text-center">${grandTotalAlerta}</td>
                <td class="px-6 py-4 text-center">-</td>
            `;
            tbody.appendChild(trTotal);
        }

        function renderStagnantGroup(containerId, countId, items, cardClass) {
            const container = document.getElementById(containerId);
            const countLabel = document.getElementById(countId);
            container.innerHTML = '';
            countLabel.textContent = items.length;
            items.sort((a, b) => b.days - a.days);

            if (items.length === 0) {
                container.innerHTML = '<div class="text-xs text-slate-400 italic p-2">¡Todo al día!</div>';
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `${cardClass} p-3 rounded shadow-sm text-sm`;
                const daysText = item.days === 999 ? 'Sin fecha' : `${item.days} días`;
                div.innerHTML = `
                    <div class="font-bold text-slate-700 truncate" title="${item.client}">${item.client}</div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs text-slate-500 bg-slate-100 px-1 rounded">${item.collector}</span>
                        <span class="font-bold text-red-600 text-xs">${daysText}</span>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 border-t pt-1">
                        Estado: <span class="italic">${item.rawStatus}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStatusChart(dataObj, totalUniverse) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            if (statusChartInstance) statusChartInstance.destroy();

            const internalLabels = ['ASIGNADA', 'CONTACTADO', 'PENDIENTES_PAGO', 'COBRADAS'];
            const displayLabels = ['ASIGNADAS', 'CONTACTADO', 'PENDIENTES PAGO', 'COBRADAS'];

            const activeUniverse = totalUniverse;

            const data = internalLabels.map(key => dataObj[key] || 0);

            if (activeUniverse === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Inter';
                ctx.fillStyle = '#94a3b8';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos activos para el mes seleccionado.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const datasets = [
                {
                    label: displayLabels[0],
                    data: [data[0]],
                    backgroundColor: ['#60a5fa'],
                    stack: 'Stack 0',
                },
                {
                    label: displayLabels[1],
                    data: [data[1]],
                    backgroundColor: ['#fde047'],
                    stack: 'Stack 0',
                },
                {
                    label: displayLabels[2],
                    data: [data[2]],
                    backgroundColor: ['#3b82f6'],
                    stack: 'Stack 0',
                },
                {
                    label: displayLabels[3],
                    data: [data[3]],
                    backgroundColor: ['#22c55e'],
                    stack: 'Stack 0',
                },
            ];

            statusChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Distribución'],
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            stacked: true,
                            display: false,
                            max: activeUniverse,
                        },
                        y: {
                            stacked: true,
                            display: false,
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 10,
                                font: { size: 11 }
                            }
                        },
                        datalabels: {
                            color: '#1f2937',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value, context) => {
                                const percent = (value * 100 / activeUniverse).toFixed(0);
                                let fullLabel = context.dataset.label;

                                if (value === 0) return '';
                                return `${fullLabel}: ${percent}%`;
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>
